<!DOCTYPE html>
<html>

<head>
    <base target="_top">
    <style>
        :root {
            --primary-color: #1a73e8;
            --primary-hover: #1557b0;
            --success-color: #34a853;
            --error-color: #ea4335;
            --background-color: #f8f9fa;
            --border-color: #dadce0;
            --text-primary: #202124;
            --text-secondary: #5f6368;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Google Sans', Roboto, Arial, sans-serif;
            padding: 16px;
            margin: 0;
            background-color: var(--background-color);
            color: var(--text-primary);
        }

        h3 {
            margin: 0 0 8px 0;
            font-size: 18px;
            font-weight: 500;
        }

        p {
            margin: 0 0 16px 0;
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .section {
            background: white;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            border: 1px solid var(--border-color);
        }

        .section-title {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 12px;
            color: var(--text-primary);
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group:last-child {
            margin-bottom: 0;
        }

        label {
            display: block;
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 6px;
            font-weight: 500;
        }

        input[type="text"],
        select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 13px;
            transition: border-color 0.2s;
        }

        input[type="text"]:focus,
        select:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        input[type="text"]::placeholder {
            color: #9aa0a6;
        }

        button {
            width: 100%;
            padding: 10px 16px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s, box-shadow 0.2s;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-hover);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        #status {
            margin-bottom: 12px;
            padding: 10px;
            border-radius: 4px;
            font-size: 13px;
            display: none;
        }

        #status.show {
            display: block;
        }

        #status.success {
            background-color: #e6f4ea;
            color: var(--success-color);
        }

        #status.error {
            background-color: #fce8e6;
            color: var(--error-color);
        }

        .help-text {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .info-box {
            background-color: #e8f0fe;
            border-radius: 4px;
            padding: 12px;
            font-size: 12px;
            color: var(--primary-color);
            margin-bottom: 16px;
            line-height: 1.5;
        }

        .info-box code {
            background-color: rgba(0, 0, 0, 0.1);
            padding: 2px 4px;
            border-radius: 2px;
            font-family: 'Roboto Mono', monospace;
        }

        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
            vertical-align: middle;
            margin-right: 8px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <h3>⚙️ 設定</h3>
    <p>スライド起草くんのアドオン設定を行います。</p>


    <div class="section">
        <div class="section-title">手動生成 (GCP 不要)</div>

        <div class="form-group">
            <label for="gemUrl">Gem とチャットを開始</label>
            <input type="text" id="gemUrl" placeholder="https://gemini.google.com/app/...">
            <div class="help-text">
                カスタム Gem の URL。GCP が設定されていない場合、アドオンはこのリンクを提示します。
            </div>
            <div style="margin-top: 8px;">
                <a href="#" onclick="openGemUrl(); return false;"
                    style="font-size: 13px; color: var(--primary-color);">Gem を開く ↗</a>
            </div>
        </div>
    </div>

    <div class="section">
        <div class="section-title">スライドテンプレート</div>

        <div class="form-group">
            <label for="templateSlideId">テンプレートスライドの URL または ID</label>
            <div style="display: flex; gap: 8px;">
                <input type="text" id="templateSlideId" placeholder="https://docs.google.com/presentation/d/..."
                    style="flex:1;">
                <button type="button" onclick="checkTemplateId()"
                    style="width: auto; padding: 0 12px; background-color: #f1f3f4; color: #3c4043; border: 1px solid #dadce0;"
                    title="アクセス権を確認">
                    確認
                </button>
            </div>
            <div id="checkStatus"
                style="font-size: 11px; margin-top: 4px; min-height: 20px; display: flex; align-items: center;"></div>
            <div class="help-text">
                テンプレートとなる Google Slides の URL または ID を入力してください。<br>
                (例: <code>https://docs.google.com/presentation/d/xxxxx/edit</code>)
            </div>
            <div style="margin-top: 12px;">
                <button type="button" onclick="createTemplate()" style="background-color: #ea4335; color: white;">
                    テンプレートを新規作成
                </button>
                <div class="help-text" style="margin-top:4px;">
                    ※ 新しいテンプレートスライドを作成し、上記のIDを自動更新します。
                </div>
            </div>
        </div>
    </div>

    <div class="section">
        <div class="section-title"
            style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;"
            onclick="toggleGcpSettings()">
            <span>Vertex AI 自動生成 (上級者向け)</span>
            <span id="gcpToggleIcon"
                style="color: var(--text-secondary); transform: rotate(0deg); transition: transform 0.2s;">▼</span>
        </div>

        <div id="gcpSettingsContent"
            style="display: none; margin-top: 16px; padding-top: 16px; border-top: 1px dashed var(--border-color);">
            <div class="info-box" style="margin-bottom: 12px;">
                ⚠️ <b>要 GCP プロジェクト</b><br>
                Google Cloud Platform の課金有効化プロジェクトが必要です。
            </div>

            <div class="form-group">
                <label for="gcpProjectId">GCP プロジェクト ID</label>
                <input type="text" id="gcpProjectId" placeholder="your-project-id">
                <div class="help-text">
                    Vertex AI API が有効化されている GCP プロジェクトの ID
                </div>
            </div>

            <div class="form-group">
                <label for="vertexAiLocation">Vertex AI リージョン</label>
                <select id="vertexAiLocation">
                    <option value="asia-northeast1">asia-northeast1 (東京)</option>
                    <option value="us-central1">us-central1 (アイオワ)</option>
                    <option value="europe-west1">europe-west1 (ベルギー)</option>
                </select>
            </div>

            <div class="form-group">
                <label for="vertexAiModel">AI モデル</label>
                <input type="text" id="vertexAiModel" list="modelOptions" placeholder="モデルを選択または入力">
                <datalist id="modelOptions">
                    <option value="gemini-2.5-flash">Gemini 2.5 Flash (推奨)</option>
                    <option value="gemini-2.5-pro">Gemini 2.5 Pro (高性能)</option>
                    <option value="gemini-3-pro">Gemini 3 Pro (プレビュー)</option>
                </datalist>
                <div class="help-text">
                    モデルを選択するか、カスタムモデル名を入力してください (例: gemini-3.0-flash)
                </div>
            </div>

            <div class="form-group">
                <label style="display:flex; align-items:center;">
                    <input type="checkbox" id="useMockResponse" style="width:auto; margin-right:8px;">
                    Mock レスポンスを使用する (テスト用)
                </label>
            </div>
        </div>
    </div>

    <div id="status" style="margin: 10px 0; padding: 10px; border-radius: 4px; min-height: 20px;"></div>

    <div style="display: flex; gap: 10px; margin-top: 10px;">
        <button class="btn-primary" onclick="saveSettings()">
            設定を保存
        </button>
    </div>

    <script>
        // Load current settings on page load
        window.onload = function () {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = '設定を読み込み中...';
            google.script.run.withSuccessHandler(function (settings) {
                if (settings) {
                    document.getElementById('gcpProjectId').value = settings.gcpProjectId || '';
                    document.getElementById('vertexAiLocation').value = settings.vertexAiLocation || 'asia-northeast1';
                    document.getElementById('vertexAiModel').value = settings.vertexAiModel || 'gemini-2.5-flash';
                    document.getElementById('gemUrl').value = settings.gemUrl || '';

                    if (document.getElementById('useMockResponse')) {
                        document.getElementById('useMockResponse').checked = settings.useMockResponse === 'true';
                    }
                    document.getElementById('templateSlideId').value = settings.templateSlideId || '';
                }
                statusDiv.textContent = '';
            }).withFailureHandler(function (err) {
                statusDiv.textContent = '設定の読み込みエラー: ' + err;
                statusDiv.style.backgroundColor = '#fce8e6';
                statusDiv.style.color = '#c5221f';
            }).getCurrentSettings();
        };

        function saveSettings() {
            const gcpProjectId = document.getElementById('gcpProjectId').value.trim();
            const vertexAiLocation = document.getElementById('vertexAiLocation').value;
            const vertexAiModel = document.getElementById('vertexAiModel').value;
            const useMockResponse = document.getElementById('useMockResponse').checked;
            const templateSlideId = document.getElementById('templateSlideId').value.trim();
            const statusDiv = document.getElementById('status');

            const gemUrl = document.getElementById('gemUrl').value.trim();
            const statusDivRef = document.getElementById('status');

            // Validation: Relaxed. Allow saving even if GCP ID is empty (for Manual Mode)
            if (!gcpProjectId && !gemUrl) {
                // Only warn if BOTH are empty
                // showStatus('error', '❌ Please configure either GCP Project ID or Gem URL.');
                // Actually, let's allow saving partially to be flexible.
            }

            // Create properties object
            const props = {
                'GCP_PROJECT_ID': gcpProjectId,
                'VERTEX_AI_LOCATION': vertexAiLocation,
                'VERTEX_AI_MODEL': vertexAiModel,
                'USE_MOCK_RESPONSE': useMockResponse.toString(),
                'TEMPLATE_SLIDE_ID': templateSlideId,
                'GEM_URL': gemUrl
            };

            // Save using the GAS backend
            statusDiv.innerHTML = '<span class="spinner"></span> 保存中...';
            statusDiv.className = 'show';
            statusDiv.style.backgroundColor = '#e8f0fe';
            statusDiv.style.color = '#1a73e8';

            google.script.run
                .withSuccessHandler(function () {
                    showStatus('success', '✅ 設定が正常に保存されました！');
                })
                .withFailureHandler(function (error) {
                    showStatus('error', '❌ エラー: ' + error.message);
                })
                .saveScriptProperties(props);
        }

        function checkTemplateId() {
            const id = document.getElementById('templateSlideId').value.trim();
            const checkStatus = document.getElementById('checkStatus');

            if (!id) {
                checkStatus.textContent = 'IDが入力されていません';
                checkStatus.style.color = '#text-secondary';
                return;
            }

            checkStatus.innerHTML = '<span class="spinner"></span> 確認中...';
            checkStatus.style.color = 'var(--text-secondary)';

            google.script.run
                .withSuccessHandler(function (result) {
                    if (result.valid) {
                        checkStatus.innerHTML = result.message;
                        checkStatus.style.color = 'var(--success-color)';
                    } else {
                        checkStatus.innerHTML = result.message;
                        checkStatus.style.color = 'var(--error-color)';
                    }
                })
                .withFailureHandler(function (err) {
                    checkStatus.innerHTML = '❌ エラー: ' + err.message;
                    checkStatus.style.color = 'var(--error-color)';
                })
                .checkSlideIdAccess(id);
        }

        function showStatus(type, message) {
            const status = document.getElementById('status');
            status.className = 'show ' + type;
            status.textContent = message;
        }

        function openGemUrl() {
            const url = document.getElementById('gemUrl').value.trim();
            if (url) {
                window.open(url, '_blank');
            } else {
                showStatus('error', '先に Gem の URL を入力してください。');
            }
        }

        function createTemplate() {
            if (!confirm('新しいテンプレートスライドを作成しますか？\n(作成完了まで数秒かかります)')) {
                return;
            }

            const statusDiv = document.getElementById('status');
            statusDiv.textContent = 'テンプレートを作成中...';
            statusDiv.className = 'show';
            statusDiv.style.backgroundColor = '#e8f0fe';
            statusDiv.style.color = '#1a73e8';

            google.script.run
                .withSuccessHandler(function (result) {
                    if (result && result.url) {
                        document.getElementById('templateSlideId').value = result.url;
                        showStatus('success', '✅ テンプレートを作成しました！\nURLが自動入力されました。');
                    } else {
                        showStatus('error', '⚠️ 作成されたようですが、情報の取得に失敗しました。');
                    }
                })
                .withFailureHandler(function (error) {
                    showStatus('error', '❌ エラー: ' + error.message);
                })
                .createTemplateSlide();
        }

        function toggleGcpSettings() {
            const content = document.getElementById('gcpSettingsContent');
            const icon = document.getElementById('gcpToggleIcon');

            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.style.transform = 'rotate(180deg)';
            } else {
                content.style.display = 'none';
                icon.style.transform = 'rotate(0deg)';
            }
        }
    </script>
</body>

</html>